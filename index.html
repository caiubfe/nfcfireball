<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Arcane Grimoire - NFC Spell Caster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    :root {
      --bg-color: #1a1a2e;
      --card-bg: #16213e;
      --accent-gold: #ffd700;
      --accent-purple: #b537f2;
      --text-color: #e0e0e0;
      --border-color: #2a2a4e;
    }

    body {
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      color: var(--accent-gold);
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
      margin-bottom: 5px;
      font-family: 'Courier New', Courier, monospace; /* æ›´æœ‰å·è½´æ„Ÿ */
    }

    .subtitle {
      font-size: 0.9rem;
      color: #888;
      margin-bottom: 30px;
    }

    /* NFC Status Area */
    .nfc-hud {
      width: 100%;
      max-width: 600px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px dashed var(--accent-purple);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .nfc-hud.active {
      border-style: solid;
      box-shadow: 0 0 15px var(--accent-purple);
      background: rgba(181, 55, 242, 0.1);
    }

    /* Spell Cards Grid */
    .spell-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
      width: 100%;
      max-width: 800px;
      margin-bottom: 40px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 15px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      border-color: var(--accent-gold);
    }

    .card h3 {
      margin: 10px 0 5px 0;
      font-size: 1.1rem;
      color: #fff;
    }

    .card .dice-tag {
      background: #333;
      color: #aaa;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-family: monospace;
    }

    .card .card-icon {
      font-size: 2rem;
      margin-bottom: 5px;
    }

    /* Modal Overlay for Results */
    .spell-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      backdrop-filter: blur(5px);
    }
    .spell-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }

    .result-box {
      background: linear-gradient(145deg, #2a1a4a, #1a1a2e);
      border: 2px solid var(--accent-gold);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      width: 80%;
      max-width: 400px;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
      transform: scale(0.8);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .spell-overlay.show .result-box {
      transform: scale(1);
    }

    .result-title {
      color: var(--accent-gold);
      font-size: 1.5rem;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .result-total {
      font-size: 5rem;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 0 20px var(--accent-purple);
      line-height: 1;
      margin: 10px 0;
    }

    .result-details {
      color: #aaa;
      font-family: monospace;
      font-size: 1rem;
    }

    .close-btn {
      margin-top: 20px;
      padding: 10px 30px;
      background: transparent;
      border: 1px solid #666;
      color: #888;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .close-btn:hover {
      border-color: #fff;
      color: #fff;
    }

    /* Manual Roll Section */
    .manual-roll {
      width: 100%;
      max-width: 600px;
      background: #222;
      padding: 15px;
      border-radius: 8px;
      display: flex;
      gap: 10px;
    }
    input {
      flex: 1;
      background: #333;
      border: 1px solid #444;
      color: #fff;
      padding: 10px;
      border-radius: 4px;
    }
    button.roll-btn {
      background: var(--accent-purple);
      color: white;
      border: none;
      padding: 0 20px;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* Admin/Tools Toggle */
    .tools-toggle {
      margin-top: 40px;
      font-size: 12px;
      color: #444;
      cursor: pointer;
      text-decoration: underline;
    }
    .admin-panel {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: #111;
      width: 100%;
      max-width: 800px;
      border-top: 1px solid #333;
    }
    .admin-panel.visible { display: block; }
    code { color: var(--accent-gold); }
    
    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>

  <header style="text-align:center">
    <h1>ARCANE GRIMOIRE</h1>
    <div class="subtitle">NFC Spell Casting & Dice Roller</div>
  </header>

  <!-- NFC HUD -->
  <div id="nfcHud" class="nfc-hud">
    <div id="nfcStatusIcon" style="font-size:24px; margin-bottom:5px;">ğŸ“¡</div>
    <div id="nfcStatusText">ç­‰å¾…é­”æ³•ä¿¡å·... (NFC)</div>
    <button id="scanNfcBtn" class="roll-btn" style="display:none; margin-top:10px; background:#333;">å¯ç”¨ NFC æ‰«æ (Android)</button>
  </div>

  <!-- Spell Grid -->
  <div id="spellArea" class="spell-list">
    <!-- JavaScript will populate this -->
    <div style="color:#666; text-align:center; width:100%;">æ­£åœ¨ä»æ³•æœ¯ä¹¦åŠ è½½å’’è¯­...</div>
  </div>

  <!-- Manual Roll -->
  <div class="manual-roll">
    <input id="manualDice" placeholder="æ‰‹åŠ¨æ–½æ³• (ä¾‹å¦‚: 8d6+5)" />
    <button id="rollBtn" class="roll-btn">ROLL</button>
  </div>

  <!-- Result Overlay (The "Big" UI) -->
  <div id="resultOverlay" class="spell-overlay">
    <div class="result-box">
      <div class="result-title" id="resTitle">FIREBALL</div>
      <div class="card-icon" style="font-size:30px">ğŸ”¥</div>
      <div class="result-total" id="resTotal">0</div>
      <div class="result-details" id="resDetails">[Rolling...]</div>
      <button class="close-btn" onclick="closeOverlay()">å…³é—­</button>
      
      <div style="margin-top:15px; font-size:12px; color:#666;">
        <span id="resDesc"></span>
      </div>
    </div>
  </div>

  <div class="tools-toggle" onclick="toggleAdmin()">æ˜¾ç¤º/éšè— æ³•æœ¯ä¹¦ç®¡ç†å·¥å…·</div>
  <div id="adminPanel" class="admin-panel">
    <h3>æ³•æœ¯ä¹¦ç®¡ç† (URL ç”Ÿæˆå™¨)</h3>
    <p>å°†ä»¥ä¸‹ URL å†™å…¥ NFC æ ‡ç­¾ï¼Œæ‰«ææ—¶å³å¯è‡ªåŠ¨æ–½æ³•ï¼š</p>
    <pre id="nfcUrls" style="white-space: pre-wrap; background: #222; padding: 10px; color: #0f0;"></pre>
  </div>

  <script>
  const spellsUrl = './spells.json';
  let spellsData = {};

  // é¢„è®¾å›¾æ ‡ï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰
  const defaultIcons = ['âœ¨', 'ğŸ”¥', 'âš¡', 'â„ï¸', 'ğŸ’€', 'ğŸ›¡ï¸', 'ğŸ‘ï¸'];

  async function loadSpells(){
    try{
      const r = await fetch(spellsUrl, {cache: "no-store"});
      if(!r.ok) throw new Error('æ— æ³•åŠ è½½ spells.json');
      spellsData = await r.json();
      renderSpells(spellsData);
      
      // Generate Admin URLs
      const urlList = Object.keys(spellsData).map(k => 
        `${k.padEnd(15)}: ${location.origin}${location.pathname}?spell=${encodeURIComponent(k)}`
      ).join('\n');
      document.getElementById('nfcUrls').textContent = urlList;

    }catch(e){
      console.warn('åŠ è½½å¤±è´¥:', e);
      document.getElementById('spellArea').innerHTML = '<div style="color:red">æ³•æœ¯ä¹¦ä¸¢å¤± (spells.json load error)</div>';
    }
  }

  function renderSpells(spells){
    const container = document.getElementById('spellArea');
    container.innerHTML = '';
    
    Object.keys(spells).forEach((key, idx) => {
      const spell = spells[key];
      const icon = spell.icon || defaultIcons[idx % defaultIcons.length];
      
      const div = document.createElement('div');
      div.className = 'card';
      div.onclick = () => castSpell(key); // Click to cast
      
      div.innerHTML = `
        <div class="card-icon">${icon}</div>
        <h3>${spell.name || key}</h3>
        <div class="dice-tag">${spell.dice || '1d20'}</div>
        <div style="font-size:12px; color:#666; margin-top:5px">${spell.desc || ''}</div>
      `;
      container.appendChild(div);
    });
  }

  // Dice Logic
  function rollDiceExpr(expr){
    try {
      expr = expr.replace(/\s+/g,'');
      // Simple parser for XdY+Z
      const m = expr.match(/^(\d+)[dD](\d+)([+-]\d+)?$/);
      if(!m) return {error: true};
      
      const count = parseInt(m[1]);
      const sides = parseInt(m[2]);
      const mod = m[3] ? parseInt(m[3]) : 0;
      
      const rolls = [];
      let total = 0;
      for(let i=0; i<count; i++){
        const val = Math.floor(Math.random()*sides) + 1;
        rolls.push(val);
        total += val;
      }
      total += mod;
      
      return { rolls, total, mod, sides, count };
    } catch(e) {
      return { error: true };
    }
  }

  // Main Action: Cast Spell
  function castSpell(key, isAuto = false) {
    const spell = spellsData[key];
    if(!spell) return;

    // 1. Show Overlay
    const overlay = document.getElementById('resultOverlay');
    const titleEl = document.getElementById('resTitle');
    const totalEl = document.getElementById('resTotal');
    const detailsEl = document.getElementById('resDetails');
    const descEl = document.getElementById('resDesc');

    titleEl.textContent = spell.name;
    descEl.textContent = spell.desc;
    detailsEl.textContent = "Rolling...";
    totalEl.textContent = "";
    overlay.classList.add('show');

    // 2. Play Audio
    if(spell.audio) {
      const audio = new Audio(spell.audio);
      audio.play().catch(e => console.log("Auto-play prevented:", e));
    }

    // 3. Roll Dice with Animation
    const result = rollDiceExpr(spell.dice || '1d20');
    
    if(result.error) {
        totalEl.textContent = "?";
        detailsEl.textContent = "Dice Error";
        return;
    }

    // Number scrambling animation
    let frame = 0;
    const maxFrames = 20;
    const animInterval = setInterval(() => {
      frame++;
      totalEl.textContent = Math.floor(Math.random() * (result.count * result.sides)) + 1;
      if(frame >= maxFrames) {
        clearInterval(animInterval);
        totalEl.textContent = result.total;
        const modStr = result.mod ? (result.mod > 0 ? `+${result.mod}` : result.mod) : '';
        detailsEl.textContent = `[${result.rolls.join(', ')}] ${modStr}`;
        
        // Pulse effect
        totalEl.style.animation = 'pulse 0.2s ease';
        setTimeout(() => totalEl.style.animation = '', 200);
      }
    }, 30);
  }

  function closeOverlay() {
    document.getElementById('resultOverlay').classList.remove('show');
    // clear query param to prevent reload re-cast
    const url = new URL(window.location);
    url.searchParams.delete('spell');
    window.history.replaceState({}, '', url);
  }

  function toggleAdmin() {
    const p = document.getElementById('adminPanel');
    p.classList.toggle('visible');
  }

  // Manual Roll Handler
  document.getElementById('rollBtn').addEventListener('click', () => {
    const val = document.getElementById('manualDice').value || '1d20';
    // Mock a spell object for manual roll
    spellsData['manual'] = { name: "Manual Roll", desc: "Custom Check", dice: val, audio: null };
    castSpell('manual');
  });

  // Init Logic
  async function init() {
    await loadSpells();

    // Check URL Params (NFC Trigger)
    const params = new URLSearchParams(window.location.search);
    const spellKey = params.get('spell');
    if(spellKey && spellsData[spellKey]) {
      // Wait a tiny bit for UI to settle
      setTimeout(() => castSpell(spellKey, true), 500);
    }

    // Web NFC Setup
    const nfcStatusText = document.getElementById('nfcStatusText');
    const scanBtn = document.getElementById('scanNfcBtn');
    const hud = document.getElementById('nfcHud');

    if ('NDEFReader' in window) {
      nfcStatusText.textContent = "æµè§ˆå™¨æ”¯æŒ Web NFCã€‚ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ‰«æã€‚";
      scanBtn.style.display = 'inline-block';
      
      scanBtn.addEventListener('click', async () => {
        try {
          const ndef = new NDEFReader();
          await ndef.scan();
          nfcStatusText.textContent = "æ­£åœ¨ç›‘å¬é­”æ³•æ³¢åŠ¨... (è¯·è´´è¿‘æ ‡ç­¾)";
          hud.classList.add('active');
          scanBtn.style.display = 'none';
          
          ndef.onreading = event => {
            const decoder = new TextDecoder();
            let url = null;
            for (const record of event.message.records) {
              // Simple logic to find URL
              if(record.recordType === "url") {
                url = decoder.decode(record.data);
              } else {
                // Fallback text decode
                url = decoder.decode(record.data);
              }
            }

            if (url) {
               // If URL belongs to this app, parse it without reload
               if(url.startsWith(location.origin + location.pathname)) {
                 try {
                   const u = new URL(url);
                   const s = u.searchParams.get('spell');
                   if(s && spellsData[s]) {
                     castSpell(s);
                     nfcStatusText.textContent = `æ£€æµ‹åˆ°æ³•æœ¯: ${s}`;
                     return;
                   }
                 } catch(e) {}
               }
               // Fallback: just navigate
               window.location.href = url;
            }
          };
        } catch (error) {
          nfcStatusText.textContent = "NFC å¯åŠ¨å¤±è´¥: " + error;
        }
      });
    } else {
      nfcStatusText.innerHTML = "å½“å‰æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥ NFC æ‰«æã€‚<br>è¯·ä½¿ç”¨æ‰‹æœºç³»ç»ŸåŸç”Ÿè¯»å–ï¼Œæˆ–åœ¨ Chrome Android ä¸­ä½¿ç”¨ã€‚";
    }
  }

  init();
  </script>
</body>
</html>